<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">
<link rel="import" href="../oc-form-container/oc-form-container.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">


<dom-module id="oc-list-organisations">
	<template>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
		<style>
			:host {
				color: #000;
				background: #fff;
			}

			.pay-button {
				background-color: #e0992f;
			}

			.order-button {
				background-color: #000;
			}

			iron-icon {
				padding-right: 5px;
			}

			paper-card {
				width: 100vw;
				left: 0;
				margin-left: -15px;
				margin-bottom: 5px;
			}

			paper-button {
				height: 2.5em;
				color: white;
				font-weight: bold;

				width: 100%;
				margin: 6px 0;
			}

			.shop-location {
				word-break: break-word;
				font-size: 0.8em;
				margin-top: 10px;
			}

			.button-container {
				margin: auto;
				font-size: 0.9em;
			}

			.right-blue-border {
				border-right: 1px solid var(--app-primary-color);
			}

			.search-input {
				box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.1), 0 0 0 0 rgba(0, 0, 0, 0.14), 0 0 0 0 rgba(0, 0, 0, 0.12);
				padding: 0 2px 0 16px;
				border: none;
				width: 100%;
				height: 40px;
				line-height: 48px;
			}
		</style>
		<oc-organisation-api id="organisationApi"></oc-organisation-api>
		<oc-form-container header="Suppliers">
			<div slot="header-content" style="padding-right: 10px">
				<paper-toggle-button id="marketToggle" checked="[[marketplace]]">Show Public</paper-toggle-button>
			</div>
			<iron-input bind-value="{{_searchText}}" class="row">
				<input class="search-input" placeholder="Search..." type="text">
			</iron-input>
			<!-- Place holder to override margin of container -->
			<div id="suppliersContainer">
				<template is="dom-repeat" items="[[organisations]]" sort="_sort">
					<paper-card>
						<div class="container-fluid">
							<div class="row" style="background-color: var(--app-content-background-color); color: var(--app-primary-color)">
								<div class="col-auto" style="background-color: white; display: flex; align-items: center; padding: 10px;">
									<img src="[[_calculateImage(item.toOrganisation.profile.imageThumb)]]" alt="Distributors Thumbnail" style="width: 70px; height: 70px; display: flex">
								</div>
								<div class="col m-auto right-blue-border">
									<div style="font-size: 1em; line-height: normal">[[item.toOrganisation.name]]</div>
									<div class="shop-location">[[item.toOrganisation.profile.address.city]]</div>
								</div>
								<div class="col button-container">
									<paper-button class="pay-button" on-tap="_payOrganisation">
										<iron-icon icon="icons:payment"></iron-icon>
										Pay
									</paper-button>
									<paper-button class="order-button" on-tap="_viewProductList">
										<iron-icon icon="icons:assignment"></iron-icon>
										Order
									</paper-button>
								</div>
							</div>
						</div>
					</paper-card>
				</template>
			</div>
		</oc-form-container>

	</template>

	<script>
        /**
         * `oc-list-organisations`
         * List of organisations that can be paid or orderedfrom
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
		class OcListOrganisations extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() {
				return 'oc-list-organisations';
			}

			static get properties() {
				return {
					//TODO: change this to work with organisation store
					_marketplaceId: {
						type: Number,
						statePath: 'config.organisationId'
					},
					_organisationId: {
						type: Number,
						statePath: 'organisation.id'
					},
					organisations: {
						type: Array,
						notify: true
					},
					hidelocation: {
						type: Boolean,
					},
					//display public connections first
					marketplace: {
						type: Boolean,
						statePath: 'identity.marketplace'
					},
					_environment: {
						type: String,
						statePath: 'config.environment'
					},
					_searchText: {
						type: String,
						observer: '_filter'
					}
				};
			}

			static get observers() {
				return [
					'_fetchOrganisations(marketplace,_organisationId)',
					'_fetchMarketplace(marketplace,_marketplaceId)'
				]
			}

			ready() {
				super.ready();
				this.$.marketToggle.addEventListener('change', function () {
					if (this.$.marketToggle.checked) {
						this.dispatch('receiveMarketplace', true);
					} else {
						this.dispatch('receiveMarketplace', false);
					}
				}.bind(this))
			}


			//fetches private
			_fetchOrganisations(marketplace, organisationId) {
				if ((organisationId)
					&& (!marketplace)) {
					this._getOrganisationConnections(organisationId, "M", 1, -1, marketplace);
				}
			}
			//fetches public connections
			_fetchMarketplace(marketplace, organisationId) {
				if ((organisationId)
					&& (marketplace)) {
					this._getOrganisationConnections(organisationId, "M", 1, -1, marketplace);
				}
			}

			_getOrganisationConnections(organisationId, type, page, pagesize, marketplace) {
				this.shadowRoot.querySelector('#organisationApi').getOrganisationConnections(organisationId, type, null, null, null, page, pagesize, marketplace)
					.then(function (request) {

						let data = request.response.results.filter(connection => connection.toOrganisation.id !== organisationId);

						this.organisations = data;
					}.bind(this));
			}

			_payOrganisation(e) {
				// Notify of payment
				this.dispatchEvent(new CustomEvent('oc-pay-organisation', {
					bubbles: true, composed: true, detail: { "organisationId": e.model.item.toOrganisation.id }
				}));
			}

			_viewProductList(e) {
				this.dispatchEvent(new CustomEvent('oc-product-list', {
					bubbles: true, composed: true, detail: { "organisationId": e.model.item.toOrganisation.id }
				}));
			}

            /**
             * Sort from closest to furthest
             * @param a first record
             * @param b second record
             * @returns {number} returns new position
             * @private
             */
			_sort(a, b) {
				if (a.distance === b.distance) return 0;
				return Number(a.distance) < Number(b.distance) ? -1 : 1;
			}

			_calculateImage(image) {
				if (image === null) {
					return '../../images/icon-144x144.png';
				} else {
					if (this._environment === "prod")
						return `https://resource.ordercloud.com/${image}`;
					else
						return "https://test-static.ordercloud.com/" + image;
				}
			}

			// This is for the searching functionality
			_filterCheck(searchText, item) {
				if (!item.__templatizeInstance) return true; // Skip template instance
				const currentValue = item.__templatizeInstance.item.toOrganisation.name;
				if (searchText === "" || currentValue === "") {
					return true;
				} else {
					const re = new RegExp(searchText, "gi");
					return re.exec(currentValue) != null;
				}
			}

			_filter(searchText) {
				const suppliersContainer = this.$.suppliersContainer;
				for (let supplier of suppliersContainer.children) {
					let display;
					if (this._filterCheck(searchText, supplier)) {
						display = 'block';
					} else {
						display = 'none';
					}
					supplier.style.display = display;
				}
			}
		}

		window.customElements.define(OcListOrganisations.is, OcListOrganisations);
	</script>
</dom-module>