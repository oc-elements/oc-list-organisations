<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">
<link rel="import" href="../oc-form-container/oc-form-container.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">


<dom-module id="oc-list-organisations">
	<template>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
			  crossorigin="anonymous">
		<style>
			:host {
				color: #000;
				background: #fff;
			}

			.pay-button {
				background-color: var(--app-accent-color);
			}

			.order-button {
				background-color: var(--app-secondary-color);
			}

			iron-icon {
				padding-right: 5px;
			}

			iron-input {
				margin-left: -10px;
				margin-right: -10px;
			}

			paper-card {
				width: 100vw;
				left: 0;
				margin-left: -15px;
				margin-bottom: 5px;
			}

			paper-button {
				height: 32px;
				color: white;
				font-weight: bold;
				min-width: 100px;
				margin: 2px 0;
				float: right;
			}

			.button-container {
				margin: auto;
				font-size: 0.9em;
				padding-right: 5px !important;
				padding-left: 5px !important;
			}

			.right-blue-border {
				border-right: 1px solid var(--app-primary-color);
			}

			.search-input {
				box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.1), 0 0 0 0 rgba(0, 0, 0, 0.14), 0 0 0 0 rgba(0, 0, 0, 0.12);
				padding: 0 2px 0 16px;
				border: none;
				width: 100%;
				height: 40px;
				line-height: 48px;

				margin-bottom: 5px;
				margin-left: 5px;
				margin-right: 5px;
			}

			.profile-image {
				width: 86px;
				height: 86px;
				background: #fff;
			}

			.profile-image img {
				width: 86px;
				height: 86px;
			}

			.organisation-name {
				font-size: 16px;
				line-height: normal;
			}

			.organisation-location {
				font-size: 14px;
			}
		</style>
		<app-location route="{{route}}" query-params="{{queryParams}}"></app-location>
		<oc-organisation-api id="organisationApi"></oc-organisation-api>
		<oc-form-container header="[[_headerLabel]]">
			<div slot="header-content" style="padding-right: 13px">
				<iron-icon style="padding: 0" icon="icons:search" on-tap="_onSearch"></iron-icon>
			</div>
			<template is="dom-if" if=[[_isSearchActive]]>
				<iron-input bind-value="{{_searchText}}" class="row">
					<input class="search-input" placeholder="Search..." type="text">
				</iron-input>
			</template>

			<!-- Place holder to override margin of container -->
			<!--Check if order page-->
			<div id="suppliersContainer">
				<template is="dom-if" if="[[_isOrder]]">
					<template is="dom-repeat" items="[[organisations]]">
						<template is="dom-if" if="[[item.acceptOrders]]">
							<paper-card>
								<div class="container-fluid">
									<div class="row" style="background-color: var(--app-content-background-color); color: var(--app-primary-color); margin:0 -11px">
										<div class="profile">
											<img src="[[_calculateImage(item.profile.imageThumb)]]" alt="Distributors Thumbnail" class="profile-image">
										</div>
										<div class="col m-auto right-blue-border">
											<div class="organisation-name">[[item.name]]</div>
											<!-- <div class="organisation-location">[[item.profile.address.city]]</div> -->
										</div>
										<div class="col button-container">
											<paper-button class="order-button" on-tap="_viewProductList">
												<iron-icon icon="icons:assignment"></iron-icon>
												Order
											</paper-button>
										</div>
									</div>
								</div>
							</paper-card>
						</template>
					</template>
				</template>

				<!--check if supplier page-->
				<template is="dom-if" if="[[!_isOrder]]">
					<template is="dom-repeat" items="[[organisations]]">
						<template is="dom-if" if="[[item.acceptPayments]]">
							<paper-card>
								<div class="container-fluid">
									<div class="row" style="background-color: var(--app-content-background-color); color: var(--app-primary-color); margin:0 -11px">
										<div class="profile">
											<img src="[[_calculateImage(item.profile.imageThumb)]]" alt="Distributors Thumbnail" class="profile-image">
										</div>
										<div class="col m-auto right-blue-border">
											<div class="organisation-name">[[item.name]]</div>
											<!-- <div class="organisation-location">[[item.profile.address.city]]</div> -->
										</div>
										<div class="col button-container">

											<paper-button class="pay-button" on-tap="_payOrganisation">
												<iron-icon icon="icons:payment"></iron-icon>
												Pay
											</paper-button>
										</div>
									</div>
								</div>
							</paper-card>
						</template>
					</template>
				</template>
			</div>
		</oc-form-container>

	</template>

	<script>
		/**
		 * `oc-list-organisations`
		 * List of organisations that can be paid or orderedfrom
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class OcListOrganisations extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() {
				return 'oc-list-organisations';
			}

			static get properties() {
				return {
					//TODO: change this to work with organisation store
					_marketplaceId: {
						type: Number,
						statePath: 'config.organisationId'
					},
					_featureFlags: {
						type: String,
						statePath: 'config.featureFlags',
					},
					_organisationId: {
						type: Number,
						statePath: 'organisation.id'
					},
					_isOrder:{
						type: Boolean,
						value: false,
						notify: true
					},
					_orderOrganisations: {
						type: Boolean,
						value: false,
						notify: true
					},
					_headerLabel: {
						type: String
					},
					organisations: {
						type: Array,
						notify: true
					},
					//display public connections first
					marketplace: {
						type: Boolean,
						statePath: 'identity.marketplace'
					},
					_environment: {
						type: String,
						statePath: 'config.environment'
					},
					_searchText: {
						type: String,
						observer: '_filter'
					},
					_isSearchActive: {
						type: Boolean,
						value: false
					}
				};
			}

			static get observers() {
				return [
					'_fetchSuppliers(_organisationId)'
				]
			}

			ready() {
				super.ready();
				this._fetchSuppliers();
				this._orderOrPay();

			}

			_orderFeature(orgId) {
				const hideOrderButton = this._featureFlags["show-order-button"]
				if (hideOrderButton && hideOrderButton.length > 0) {
					for (let id of hideOrderButton) {
						if (id === orgId) return true;
					}
				}

				return !!this._featureFlags["orders"];
			}

			_onSearch() {
				this._isSearchActive = !this._isSearchActive;
			}


			//fetches all connected organisations
			_fetchSuppliers(organisationId) {
				if (!organisationId) return;
				this._getAllSuppliers(organisationId);
			}

			_getAllSuppliers(organisationId) {
				this.$.organisationApi.getAllOrganisations(organisationId, 1, -1)
						.then(function (request) {
							this.organisations = request.response.results;
						}.bind(this));
			}


			_payOrganisation(e) {
				// Notify of payment
				// If status is status == new; Take me to payment screen
				this.dispatchEvent(new CustomEvent('change-page', {
					bubbles: true, composed: true, detail: {
						url: '/orders/unpaid-orders/' + e.model.item.id,
					}
				}));
			}

			_viewProductList(e) {
				this.dispatchEvent(new CustomEvent('oc-product-list', {
					bubbles: true, composed: true, detail: { "organisationId": e.model.item.id }
				}));
			}


			_calculateImage(image) {
				if (image === null) {
					return '../../images/icon-144x144.png';
				} else {
					if (this._environment === "prod")
						return `https://resource.ordercloud.com/${image}`;
					else
						return "https://test-static.ordercloud.com/" + image;
				}
			}

			_orderOrPay() {
				if (this.route.path === "/order") {
					this._isOrder = true;
					this._headerLabel = 'Place Order';
				}
				else if(this.route.path === "/suppliers") {
					this._isOrder = false;
					this._headerLabel = 'Pay Suppliers';
				}
			}

			// This is for the searching functionality
			_filterCheck(searchText, item) {
				if (!item.__templatizeInstance) return true; // Skip template instance
				const currentValue = item.__templatizeInstance.item.name;
				if (searchText === "" || currentValue === "") {
					return true;
				} else {
					const re = new RegExp(searchText, "gi");
					return re.exec(currentValue) != null;
				}
			}

			_filter(searchText) {
				const suppliersContainer = this.$.suppliersContainer;
				for (let supplier of suppliersContainer.children) {
					let display;
					if (this._filterCheck(searchText, supplier)) {
						display = 'block';
					} else {
						display = 'none';
					}
					supplier.style.display = display;
				}
			}
		}

		window.customElements.define(OcListOrganisations.is, OcListOrganisations);
	</script>
</dom-module>
