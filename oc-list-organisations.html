<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">


<dom-module id="oc-list-organisations">
    <template>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
            :host {

                color :#000;
                background: #fff;
            }
            h2 {
                font-size:1.375em !important;
            }
            .category-heading {
                border-top: 1px #cecece solid;
                border-bottom: 1px #cecece solid;
                background: #f8f8f8;
                color: #000;
                line-height:2.6;
                font-weight:bold;
            }
            .heading-label {
                font-size:1.13em !important;
                margin: 20px 0 !important;

            }
            .organisation-icon {
                padding:0 5px;
                width: 24px;
            }
            .organisation-title {
                margin-top:0;
            }

            .favourite-icon {
                width: 24px;
            }
            paper-card {
                width:100%;
                -webkit-border-radius: 6px;
                -moz-border-radius: 6px;
                border-radius: 6px;
            }
            .organisation-logo-container {
                position: absolute;
                top: 4px;
                left: 0;
                bottom: 0;
                width: 96px;
                background: #fff;
            }
            .organisation-logo-container img {
                width: 100%;
                margin: 6px;
            }
            .card-content {
                margin-left:96px;
            }
            .card-actions {
                margin-left:112px;
            }
            .actions-row-left-adjusted {
                margin-left: -32px !important;
            }
            .organisation-logo-container {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                position: absolute;
                top: 4px;
                left: 0;
                bottom: 0;
                width: 96px;
                background: #fff;
            }
            organisation-title-container {
                margin-right:25px;
                vertical-align: middle
            }
            .organisation-logo-container img {
                width: 100%;
                margin: 6px;
            }

            .card-content {
                margin-left:96px;
            }
            .card-actions {
                margin-left:112px;
            }
            .actions-row-left-adjusted {
                margin-left: -32px !important;
            }
        </style>
        <oc-organisation-api id="organisationApi"></oc-organisation-api>
        <div class="container-fluid">
            <div class="row category-heading">
                <div class="col-xs-12">
                    <span class="heading-label">Shops</span>
                    <span class="pull-right"><paper-toggle-button checked="{{!marketplace}}">Show Private</paper-toggle-button></span>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <template is="dom-repeat" items="[[organisations]]" sort="_sort">
                <paper-card>
                    <div class="organisation-logo-container" on-tap="_viewProductList">
                        <img src="[[_calculateImage(item.toOrganisation.profile.imageThumb)]]" alt="Distributors Thumbnail">
                    </div>
                    <div class="card-content">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="organisation-title-container" on-tap="_viewProductList">
                                    <h2 class="organisation-title">[[item.toOrganisation.name]]</h2>
                                    <span>[[item.toOrganisation.profile.address.city]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <div class="row actions-row-left-adjusted">
                            <div class="col-xs-6">
                                <paper-button raised on-tap="_payOrganisation"><img src="../../images/Pay-Icon.png" alt="Pay Icon" class="organisation-icon">Pay</paper-button>
                            </div>
                            <div class="col-xs-6" hidden$="[[hidelocation]]">
                                <paper-button><img src="../../images/Map-Pin-Icon.png" alt="Map Pin Icon" class="organisation-icon">[[item.distance]]km</paper-button>
                            </div>
                        </div>
                    </div>
                </paper-card>
            </template>
        </div>
    </template>

    <script>
		/**
		 * `oc-list-organisations`
		 * List of organisations that can be paid or orderedfrom
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class OcListOrganisations extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() { return 'oc-list-organisations'; }
			static get properties() {
				return {
					//TODO: change this to work with organisation store
					_marketplaceId: {
						type: Number,
						statePath: 'config.organisationId'
					},
					_organisationId: {
						type: Number,
						statePath: 'organisation.id'
					},
					organisations: {
						type: Array,
						notify: true
					},
					latitude: {
						type: String,
						value: -33.924246
					},
					longitude: {
						type: String,
						value: 18.41398
					},
					radius: {
						type: String,
						value: 10000000
					},
					hidelocation: {
						type: Boolean,
					},
					//display public connections first
					marketplace: {
						type: Boolean,
						value: true,
					}
				};
			}

			static get observers(){
				return [
					'_fetchOrganisations(marketplace,_organisationId)',
					'_fetchMarketplace(marketplace,_marketplaceId)'

				]
			}

			ready() {
				super.ready();
			}


			//fetches private
			_fetchOrganisations(marketplace,organisationId) {
				if((organisationId)
					&&(!marketplace)) {
					this._getOrganisationConnections(organisationId, "M", this.radius, this.latitude, this.longitude, 1, -1, marketplace);
				}
			}

			//fetches public connections
			_fetchMarketplace(marketplace, organisationId) {
				if((organisationId)
					&&(marketplace)){
					this._getOrganisationConnections(organisationId, "M", this.radius, this.latitude, this.longitude, 1, -1, marketplace);
				}
			}

			_getOrganisationConnections(organisationId, type, radius, lat ,long , page, pagesize, marketplace) {
				this.shadowRoot.querySelector('#organisationApi').getOrganisationConnections(organisationId, type, radius, lat ,long , page, pagesize, marketplace)
					.then(function(request){

						let data = request.response.results.filter(connection => connection.toOrganisation.id !== organisationId);

						this.organisations = this._calculateDistances(data);
					}.bind(this));
			}

			_payOrganisation(e) {
				// Notify of payment
				this.dispatchEvent(new CustomEvent('oc-pay-organisation', {
					bubbles: true, composed: true, detail: {"organisationId" :  e.model.item.toOrganisation.id, "marketplace" : false}
				}));
			}

			_viewProductList(e) {
				this.dispatchEvent(new CustomEvent('oc-product-list', {
					bubbles: true, composed: true, detail: {"organisationId" :  e.model.item.toOrganisation.id, "marketplace" : true}
				}));
			}



			/**
			 * Calculated the distance between current location and organisations
			 *
			 */
			_calculateDistances(organistations) {
				var calculatedOrganisations=[];

				for (var i = 0; i < organistations.length; i++) {
					calculatedOrganisations[i] = organistations[i];
					if(organistations[i].toOrganisation.profile.address !== null) {
						calculatedOrganisations[i].distance = this._getDistanceFromLatLonInKm(this.latitude, this.longitude, organistations[i].toOrganisation.profile.address.latitude, organistations[i].toOrganisation.profile.address.longitude);
					}else{
						calculatedOrganisations[i].distance = "N/A"
					}
				}
				return calculatedOrganisations;
			}

			/**
			 * Calculates the distance between two geo corditanes
			 * @param lat1 lattiude of starting point
			 * @param lon1 longitude of starting point
			 * @param lat2 lattiude of ending point
			 * @param lon2 longitude of ending point
			 * @returns {number}
			 * @private
			 */
			_getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
				var R = 6371; // Radius of the earth in km
				var dLat = this._deg2rad(lat2-lat1);  // deg2rad below
				var dLon = this._deg2rad(lon2-lon1);
				var a =
					Math.sin(dLat/2) * Math.sin(dLat/2) +
					Math.cos(this._deg2rad(lat1)) * Math.cos(this._deg2rad(lat2)) *
					Math.sin(dLon/2) * Math.sin(dLon/2)
				;
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				var d = R * c; // Distance in km
				return d.toFixed(0);
			}

			/**
			 * converts degrees to Rad
			 * @param deg
			 * @returns {number}
			 */
			_deg2rad(deg) {
				return deg * (Math.PI/180)
			}

			/**
			 * Sort from closest to furthest
			 * @param a first record
			 * @param b second record
			 * @returns {number} returns new position
			 * @private
			 */
			_sort(a, b) {
				if (a.distance === b.distance) return 0;
				return Number(a.distance) < Number(b.distance) ? -1 : 1;
			}

			_calculateImage(image){
				if(image === null){
					return '../../images/elmi-distributors.png';
				}else{
					return "https://test-static.ordercloud.com/" + image;
				}
			}
		}

		window.customElements.define(OcListOrganisations.is, OcListOrganisations);
    </script>
</dom-module>
